<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kyobobook.application.adapter.out.persistence.cart.CartReaderMapper">

    <!--
        설명     : 장바구니 목록 조회(임시용)
        작성일자  : 2021. 11. 11.
        작성자   : seohee.ko@kyobobook.com
    -->
	<select id="selectCartList" resultType="TmSpbkEntity">
        SELECT /* CartWriterMapper.selectCartList */
		    *
        FROM
            eos.tm_spbk
        WHERE spbk_dvsn_code = '002'
          AND dlt_ysno = 'N'
        ORDER BY AMND_DTTM desc
        LIMIT 10 OFFSET 0
    </select>
    
    <!--
    설명     : 회원의 최근 상품코드 정보 리턴
    작성일자  : 2021. 11. 25.
    작성자   : eszho@kyobobook.com
    -->
    <select id="selectNewProductCode" parameterType="java.lang.String" resultType="TestEntity">
    SELECT /* CartWriterMapper.selectNewProductCode */
           unfy_cmdt_id AS unfyCmdtId
      FROM ( SELECT unfy_cmdt_id
                  , rank() OVER(partition by mmbr_num order by amnd_dttm desc)
               from eos.tm_spbk 
              WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
              group by  mmbr_num,unfy_cmdt_id,  amnd_dttm)
     WHERE rank = 1
     limit 1
    </select>
    
       
    <!--
    설명    : 장바구니 그룹별 목록 조회
    작성일자  : 2021. 11. 29.
    작성자   : eszho@kyobobook.com
    -->
    <select id="selectCartGroupList" parameterType="java.lang.String" resultType="TmSpbkEntity">
        SELECT spbk_id                                                                        /** 장바구니 ID      **/
             , spbk_dvsn_code                                                                 /** 장바구니구분코드    **/
             , spbk_kind_code                                                                 /** 장바구니종류코드    **/
             , decode(spbk_kind_code, '010', '교보배송'
                                    , '020', '바로드림'
                                    , '030', '업체배송'
                                    , '040', '디지털배송'
                                    , '050', '정기배송'
                                    , '060', '중고장터'
                                    , '070', '북모닝CEO'
                                    , '080', '북토큰'
                                    , '090', '분철'
                                    , '없음'          )                                        spbk_kind_name                                                                     
             , unfy_cmdt_id                                                                   /** 통합상품ID      **/
             , unt_itm_srmb                                                                   /** 단위품목순번     **/
             , mmbr_num                                                                       /** 회원번호        **/
             , requ_qntt                                                                      /** 요청수량        **/
             , mmbr_ysno                                                                      /** 회원여부        **/
             , frbe_ysno                                                                      /** 사은품여부       **/
             , amnd_dttm            
          FROM(
                 ( 
                      SELECT a.spbk_id                                                                      
                           , a.spbk_dvsn_code                                                               
                           , a.spbk_kind_code                                                                                                                                                   
                           , a.unfy_cmdt_id                                                                 
                           , a.unt_itm_srmb                                                                 
                           , a.mmbr_num                                                                     
                           , a.requ_qntt                                                                    
                           , a.mmbr_ysno                                                                    
                           , a.frbe_ysno                                                                    
                           , a.amnd_dttm  
                        FROM eos.tm_spbk a
                       WHERE EXISTS ( SELECT '1' 
                                        FROM (   SELECT spbk_kind_code
                                                      , rank() OVER(order by max(amnd_dttm) desc)
                                                   FROM eos.tm_spbk 
                                                  WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                  GROUP BY spbk_kind_code) 
                                       WHERE rank = 1  
                                         AND spbk_kind_code = a.spbk_kind_code)
                          AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                        ORDER BY amnd_dttm desc
                    )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 2  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 3  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 4  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 5  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 6  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 7 
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 8  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                        )
                    UNION ALL
                    ( 
                          SELECT a.spbk_id                                                                      
                               , a.spbk_dvsn_code                                                               
                               , a.spbk_kind_code                                                                                                                                                   
                               , a.unfy_cmdt_id                                                                 
                               , a.unt_itm_srmb                                                                 
                               , a.mmbr_num                                                                     
                               , a.requ_qntt                                                                    
                               , a.mmbr_ysno                                                                    
                               , a.frbe_ysno                                                                    
                               , a.amnd_dttm  
                            FROM eos.tm_spbk a
                           WHERE EXISTS ( SELECT '1' 
                                            FROM (   SELECT spbk_kind_code
                                                          , rank() OVER(order by max(amnd_dttm) desc)
                                                       FROM eos.tm_spbk 
                                                      WHERE mmbr_num = #{memberId, jdbcType=VARCHAR}
                                                      GROUP BY spbk_kind_code) 
                                           WHERE rank = 9  
                                             AND spbk_kind_code = a.spbk_kind_code)
                              AND mmbr_num = #{memberId, jdbcType=VARCHAR}
                            ORDER BY amnd_dttm desc
                    )
                )
    </select>
    
    <!--
    설명    : 장바구니 특정상품 조회
    작성일자  : 2021. 12. 2.
    작성자   : seohee.ko@kyobobook.com
    -->
    <select id="selectCartProduct" parameterType="TmSpbkEntity" resultType="TmSpbkEntity">
     SELECT /* CartReaderMapper.selectCartProduct */
            * 
	   FROM eos.tm_spbk ts
	  WHERE unfy_cmdt_id = #{unfyCmdtId}
	    AND mmbr_num = #{mmbrNum}
	    AND dlt_ysno = 'N'
        AND spbk_dvsn_code = '002'
    </select>
    
    <!--
    설명    : 장바구니 선택상품 목록 조회 
    작성일자  : 2021. 12. 2.
    작성자   : seohee.ko@kyobobook.com
    -->
    <select id="selectCartProducts" parameterType="java.lang.String" resultType="TmSpbkEntity">
     SELECT /* CartReaderMapper.selectCartProducts */
            *
	   FROM eos.tm_spbk ts 
	  WHERE mmbr_num = #{mmbrNum}
	    AND chek_ysno = 'Y'
        AND dlt_ysno = 'N'	     
        AND spbk_dvsn_code = '002'
    </select>
    
</mapper>