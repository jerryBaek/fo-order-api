<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kyobobook.application.adapter.out.persistence.product.ProductReaderMapper">

    <!--
        설명     : Product 목록 조회
        작성일자  : 2021. 08. 30.
        작성자   : sykim@kyobobook.com
    -->
    <select id="selectProducts" resultType="ProductEntity">
        SELECT /* ProductReaderMapper.selectProducts */
            t1.cmdt_id         /* 상품 id pk */
            , t1.cmdt_name     /* 상품명 */
            , t1.sbtt_name1    /* 상품 부제목 */
            , t1.rlse_date     /* 출간일 */
            , t1.cmdt_code     /* ISBN */
            , t2.wncr_prce     /* 원화 정가 */
        FROM tm_cmdt t1
        LEFT JOIN td_cmdt_prce t2
               ON t1.cmdt_id = t2.cmdt_id
        WHERE t2.apl_end_dttm = '99991231235959'
        ORDER BY t1.cmdt_id DESC
    </select>

    <!--
        설명     : Products 상세 조회
        작성일자  : 2021. 08. 30.
        작성자   : sykim@kyobobook.com
    -->
    <select id="getProduct" resultType="ProductEntity">
        SELECT /* ProductReaderMapper.getProduct */
            t1.cmdt_id         /* 상품 id pk */
            , t1.cmdt_name     /* 상품명 */
            , t1.sbtt_name1    /* 상품 부제목 */
            , t1.rlse_date     /* 출간일 */
            , t1.cmdt_code     /* ISBN */
            , t2.wncr_prce     /* 원화 정가 */
        FROM tm_cmdt t1
        LEFT JOIN td_cmdt_prce t2
               ON t1.cmdt_id = t2.cmdt_id
        WHERE t2.apl_end_dttm = '99991231235959'
          AND t1.cmdt_id = #{id}
    </select>

    <!-- 오류 발생용 Query :: READER 권한 Database에 등록 오류 발생 -->
    <!--
        설명     : 상품 마스터 (TM_CMDT) 등록
        작성일자  : 2021. 08. 30.
        작성자   : sykim@kyobobook.com
    -->
    <insert id="insertProductCmdt" parameterType="ProductEntity">

        <selectKey keyProperty="cmdt_id,cmdt_code" resultType="ProductEntity" order="BEFORE">
            SELECT cast((cast(max(cmdt_id) AS bigint)+1) AS varchar) cmdt_id,
                   cast((cast(max(cmdt_code) AS bigint)+1) AS varchar) cmdt_code
            FROM tm_cmdt
        </selectKey>

        INSERT INTO /* ProductWriterMapper.insertProductCmdt */
        TM_CMDT (
            cmdt_id
            , cmdt_name
            , sbtt_name1
            , rlse_date
            , cmdt_code
            , cret_dttm
            , amnd_dttm
        ) VALUES (
            #{cmdt_id}
            , #{cmdt_name}
            , #{sbtt_name1}
            , #{rlse_date}
            , #{cmdt_code}
            , now()
            , now()
        )
    </insert>

    <!--
        설명     : 상품 정가 (TD_CMDT_PRCE) 등록
        작성일자  : 2021. 08. 31.
        작성자   : sykim@kyobobook.com
    -->
    <insert id="insertProductPrce" parameterType="ProductEntity">
        INSERT INTO /* ProductWriterMapper.insertProductPrce */
        TD_CMDT_PRCE (
            cmdt_id
            , wncr_prce
            , apl_end_dttm
            , cret_dttm
            , amnd_dttm
        ) VALUES (
            #{cmdt_id}
            , #{wncr_prce}
            , '99991231235959'
            , now()
            , now()
        )
    </insert>

</mapper>
